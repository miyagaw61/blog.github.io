環境構築    
---------

# 前半vagrantで環境を構築していますが、netconsole回りで詰まったため、VirtualBoxでの環境構築に後から変更したため、飛ばしてください。
> 
> vagrantbox.esからofficial ubuntu14 amd 64のURLをコピーし、vagrantのboxを作る    
> 
> ```bash
> vagrant box add [name(今回はubuntu14)] [URL]    
> vagrant init    
> ```
> 
> vagrantに2コアを与えるため、Vagrantfileに下記を追記    
> 
> ```
> config.vm.provider :virtualbox do |vb|    
>   vb.customize ["modifyvm", :id, "--memory", "2048", "--cpus", "2", "--ioapic", "on"]    
> end    
> ```
> 
> vagrantにSWAPを4GB与えるため、下記のコード(increase_swap.sh)をVagrantfileと同じディレクトリに配置    
> 
> ```
> #!/bin/sh    
>     
> # size of swapfile    
> swapsize=4G    
>     
> # does the swap file already exist?    
> grep -q "swapfile" /etc/fstab    
>     
> # if not then create it    
> if [ $? -ne 0 ]; then    
>   echo 'swapfile not found. Adding swapfile.'    
>   fallocate -l ${swapsize} /swapfile    
>   chmod 600 /swapfile    
>   mkswap /swapfile    
>   swapon /swapfile    
>   echo '/swapfile none swap defaults 0 0' >> /etc/fstab    
> else    
>   echo 'swapfile found. No changes made.'    
> fi    
>     
> # output results to terminal    
> df -h    
> cat /proc/swaps    
> cat /proc/meminfo | grep Swap    
> ```
> 
> Vagrantfileに下記を追記    
> 
> ```
> config.vm.provision "shell", path: "increase_swap.sh"    
> ```
> 
> 共有ディレクトリの設定をする    
> 第一引数がホストのディレクトリ、第二引数がゲストのディレクトリ。    
> 
> ```
> config.vm.synced_folder "/home/miyagaw61/vagrant_shared", "/shared", owner: "vagrant", group: "vagrant"    
> ```
> 
> vagrantを立ち上げ、正しく接続できることを確認する。    
> 
> ```
> vagrant up    
> vagrant ssh    
> ```
> 
> 一度落とす。    
> 
> ```
> shutdown -h now    
> ```
> 
> root権限でGUIエクスプローラーを開く    
> 
> ```
> nautilus    
> ```
> 
> open withタブでVirtualBoxをaddし  
> VBOXをダブルクリックでVirtualBoxで開く    
> GuestAdditionsを導入する    

# ここから始めてください。

Bridge設定にして、GuestAdditionsを導入する

```bash
(GUI) Devices -> Insert Guest Additions CD image...    
mkdir -p /media/cdrom    
mkdir -p $HOME/VBoxLinuxAdditions    
mount /dev/cdrom /media/cdrom    
cp -a /media/cdrom/* $HOME/VBoxLinuxAdditions/    
cd $HOME/VBoxLinuxAdditions    
./VBoxLinuxAdditions.run    
```


カーネル開発用ライブラリを導入する    

```
apt-get -y install libncurses5-dev    
apt-get -y install fakeroot    
apt-get -y install linux-headers-generic    
apt-get -y install linux-headers-$(uname -r)    
apt-get -y install virtualbox-guest-dkms    
```

gitからexploit対象のOSのバニラカーネルを落とす    

```bash
git clone --depth=1 -b v3.12 https://github.com/torvalds/linux.git $HOME/kernel/linux-3.12    
```

カーネルのコンフィグを行う    

```bash
cd $HOME/kernel/linux-3.12    
make localmodconfig #lsmodの結果を取得    
make menuconfig #それを元に.configをTUIで編集    
```

```
Kernel Hacking --->     
  <*> KGDB: kernel debugger    
    
Device Drivers --->     
  Network device support --->         
<M> Network console logging support (EXPERIMENTAL)    
```

ソースをbuildする    

```bash
make -j4    
make modules_install    
make install    
```

```bash
vim /etc/default/grub    
```

```
- GRUB_HIDDEN_TIMEOUT=0    
+ #GRUB_HIDDEN_TIMEOUT=0   
- GRUB_TIMEOUT=0    
+ GRUB_TIMEOUT=999    
```

```bash
vim /etc/default/grub.d/50-cloudimg-settings.cfg    
```

```
- GRUB_TIMEOUT=0    
+ GRUB_TIMEOUT=999    
```

```bash
update-grub    
```

shutdownでvagrantから抜ける    

```bash
shutdown -h now    
```
# 飛ばしてください

> root権限でGUIエクスプローラーを開く    
> 
> ```bash
> nautilus    
> ```
> 
> /root/VirtualBox\ VMs/にあるvmdk,vboxのプロパティを開く    
> open withタブでVirtualBoxをaddし、ダブルクリックでVirtualBoxで開く    
> VirtualBoxが開くので、待機（ここでVirtualBox側から起動してしまうとVagrantでのディレクトリ共有が行われなくなってしまう）  
> Vagrantから起動する  
> 
> ```bash
> vagrant up  
> ```

VirtualBoxでのVBOXの表示がRUNNINGになるので、TIMEOUTに設定した時間内にhowする  
GRUBが開くので、TIMEOUTで設定した時間内にAdvanced Optionsを選ぶ    
3.12.0を選択    
ユーザ名とパスワードはどちらもvagrant。    
これでカーネルのバージョンを変更することができた。    
uname -rコマンドをすると、正しく3.12.0になっていることが確認できるだろう。    
共有ディレクトリが切れてしまっているので、再び有効にする。    

```bash
apt-get -y install --reinstall virtualbox-guest-dkms    
```

netconsoleを使用します。
6665:送信側（ターゲットマシン）のポート
192.168.100.105:送信側のIPアドレス（ブリッジ）
6666:受信側（ホストマシン）のポート
192.168.100.103:受信側（ホストマシン）のIPアドレス

```bash
modprobe netconsole netconsole=6665@192.168.100.105/eth1,6666@192.168.100.103/
```

送信側のログレベルをdebugレベルに変更

```bash
dmesg -n debug
```

受信側で待機

```bash
nc -lu 6666
```

送信する

```bash
echo hoge > /dev/kmsg
```

受信側で出力される

参考にしたURL
=============

[8.10. カーネルのコンパイル](https://debian-handbook.info/browse/ja-JP/stable/sect.kernel-compilation.html)  
[Linux Kernel Hack入門編](http://kernhack.hatenablog.com/entry/2014/12/25/001336)  
[GRUB を設定する](http://www.usupi.org/sysad/202.html)  
[GRUBの設定](http://christina04.blog.fc2.com/blog-entry-155.html)  
[Kernel/Netconsole - Ubuntu Wiki](https://wiki.ubuntu.com/Kernel/Netconsole)  
[netconsoleを使ってみる - syuu1228's blog](http://syuu1228.hatenablog.com/entry/20130424/1366834414)  
[kgdb, kdb の使い方と、カーネルデバッガーの内部 - kandamotohiro](https://sites.google.com/site/kandamotohiro/linux/kgdb)  
[C/J Prog's Blog: カーネルをデバッグするためのGRUB2設定](http://tbaba-prog.blogspot.jp/2011/10/grub2.html)  
[VirtualBoxでLinuxカーネルのデバッグ環境を作る Masafumi's Blog](http://masaf.me/?p=98)  
[kgdbを用いたカーネルデバッグ環境の構築 - big-eyed-hamsterの日記](http://d.hatena.ne.jp/big-eyed-hamster/20090331/1238470673)  
[VirtualBoxでシリアルポート（COMポート）を使う](http://sgry.jp/blog/2011/04/24/429/)  
[デバッグ: VirtualBox +CentOS7 で kdb/kgdb の 素振り - hibomaの日記](http://hiboma.hatenadiary.jp/entry/2016/11/15/114459)  
